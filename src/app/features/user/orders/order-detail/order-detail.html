<div class="order-detail-page">
  <div class="container">

    @if (cargando()) {
      <div class="state-box"><div class="spinner"></div><p>Cargando pedido...</p></div>
    }

    @if (!cargando() && error()) {
      <div class="state-box state-box--error">
        <h3>No se pudo cargar el pedido</h3>
        <a routerLink="/usuario/pedidos" class="btn btn-outline">← Mis pedidos</a>
      </div>
    }

    @if (!cargando() && !error() && pedido()) {

      <div class="page-header">
        <div>
          <h1 class="page-header__title">Pedido #{{ pedido()!.id }}</h1>
          <nav class="page-header__breadcrumb">
            <a routerLink="/home">Inicio</a> /
            <a routerLink="/usuario/pedidos">Mis pedidos</a> /
            <span>#{{ pedido()!.id }}</span>
          </nav>
        </div>
        <a routerLink="/usuario/pedidos" class="btn btn-outline">← Volver</a>
      </div>

      <div class="detail-layout">

        <!-- Columna principal -->
        <div class="detail-main">

          <!-- Timeline de estado -->
          <div class="detail-card">
            <div class="detail-card__header">
              <h2 class="detail-card__title">Estado del pedido</h2>
              <span class="badge" [ngClass]="estadoClass(pedido()!.estado)">
                {{ estadoLabel(pedido()!.estado) }}
              </span>
            </div>
            <div class="timeline">
              @for (step of ['PENDIENTE','CONFIRMADO','EN_PREPARACION','ENVIADO','ENTREGADO']; track step) {
                <div class="timeline__step"
                     [class.done]="isStepDone(pedido()!.estado, step)"
                     [class.active]="pedido()!.estado === step">
                  <div class="timeline__dot"></div>
                  <span class="timeline__label">{{ estadoLabel(step) }}</span>
                </div>
              }
            </div>
          </div>

          <!-- Productos -->
          <div class="detail-card">
            <h2 class="detail-card__title">Productos</h2>
            <table class="products-table">
              <thead>
                <tr>
                  <th>Producto</th><th>Medida</th>
                  <th>Cant.</th><th>Precio unit.</th><th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                @for (item of (pedido()?.detalles || pedido()?.items || []); track item.id) {
                  <tr>
                    <td>
                      <p class="prod-nombre">{{ item.nombreProducto }}</p>
                      <p class="prod-marca">{{ item.marcaProducto }}</p>
                    </td>
                    <td class="td-center">{{ item.medidaProducto || '—' }}</td>
                    <td class="td-center">{{ item.cantidad }}</td>
                    <td class="td-right">S/ {{ item.precioUnitario | number:'1.2-2' }}</td>
                    <td class="td-right td-bold">S/ {{ item.subtotal | number:'1.2-2' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Dirección -->
          <div class="detail-card">
            <h2 class="detail-card__title">Datos de entrega</h2>
            <div class="address-grid">
              <div class="address-field">
                <span class="address-field__label">Nombre</span>
                <span>{{ pedido()?.usuario?.nombreCompleto || pedido()?.nombreInvitado }}</span>
              </div>
              <div class="address-field">
                <span class="address-field__label">Teléfono</span>
                <span>{{ pedido()?.telefonoContacto || pedido()?.telefonoInvitado }}</span>
              </div>
              <div class="address-field">
                <span class="address-field__label">Dirección</span>
                <span>{{ pedido()?.direccionEnvio }}</span>
              </div>
              <div class="address-field">
                <span class="address-field__label">Distrito / Ciudad</span>
                <span>{{ pedido()?.distritoEnvio }}, {{ pedido()?.ciudadEnvio }}</span>
              </div>
            </div>
          </div>

        </div>

        <!-- Resumen lateral -->
        <aside class="detail-aside">
          <div class="detail-card">
            <h2 class="detail-card__title">Resumen de pago</h2>
            <div class="summary-lines">
              <div class="summary-line">
                <span>Subtotal (sin IGV)</span>
                <span>S/ {{ subtotal() | number:'1.2-2' }}</span>
              </div>
              <div class="summary-line">
                <span>IGV (18%)</span>
                <span>S/ {{ igv() | number:'1.2-2' }}</span>
              </div>
              <div class="summary-line">
                <span>Envío</span>
                <span class="text-muted">Incluido</span>
              </div>
            </div>
            <div class="summary-total">
              <span>Total</span>
              <strong>S/ {{ pedido()!.total | number:'1.2-2' }}</strong>
            </div>
            <div class="summary-meta">
              <div class="meta-item">
                <span class="meta-item__label">Método de pago</span>
                <span>{{ metodoLabel(pedido()!.metodoPago) }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-item__label">Fecha del pedido</span>
                <span>{{ pedido()!.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              @if (pedido()!.notas) {
                <div class="meta-item">
                  <span class="meta-item__label">Notas</span>
                  <span>{{ pedido()!.notas }}</span>
                </div>
              }
            </div>
          </div>
        </aside>

      </div>
    }
  </div>
</div>